<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IGEM/UP/1 Testing &amp; Purging Procedure Builder</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#005ea5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAD4UlEQVR4nO3T1Y4dVxCG0XLMkJiZOU/lMDMnDjjgMKPHHsPYTp5zpx5hLuaoNf2vklapLlu99VVd+W9ArLry74BYk38ATKme6AWpJv8AmNKGXpCqNjzZB4QSANEEQLTa8FQfEKoe6QWpBEC0euTpPiCUAIjWATwckKo2PvNwQCoBEE0ARKuNz/YBoQRAtNr03MMBqQRANAEQrTY93weEqs29IJUAiFabX+gDQgmAaB3AgwGpasuLDwakEgDRBEC02vJSHxBKAESrrb0gVW19uQ8IJQCiCYBotfWVPiBUbesFqWrbq31AqA7g/oBUAiBabX/t/oBUAiCaAIhW21/vA0IJgGi1oxekqh1v9AGhBEA0ARCtdrzZB4Sqnb0glQCIVjvfWhmQSgBEEwDRatfbKwNSCYBoteudPiCUAIgmAKLVo++ujLkxaz9Tv+miCMCsaqZ+UwEIYNKZ+k0XF8B7fcyMWfuZ+k0XpR7rNTdm7WfqN10UAZhVzdRvurgA3r835sas/Uz9posiALOqmfpNBQALULs/uDcglQCIJgCi1e4P+4BQAiBa7fno3oBUAiCaAIhWe672AaEEQLTae/XugFS19+M+IJQAiCYAotW+T+4OSCUAogmAaLXv0z4glACIVvt7Qara/1kfM2PWfqZ+00URgFnVTP2mAhDApDP1my4ugGt9zIxZ+5n6TRelDly7M+bGrP1M/aaLUgc+72NmzNrP1G+6KAIwq5qp31QAAph0pn7TxQXwRR8Qqg72glQCIFod/LIPCCUAogmAaHXoqzsDUgmAaAIgWh263geEqsPXbw9IJQCi1eGv+4BQAiCaAIhWR765PSCVAIhWR77tA0IJgGgCIFod/e72mJu5ztT/dY4EsI5m6v86RwJYRzP1f52jOvr98pibuc7U/3WOBLCOZur/Okd1rNfczHWm/q9zVMd+6GNm5jpT/9c5EsA6mqn/6xzNMgBYrTr+4/KAVAIgmgCIVsd/6gNCCYBodeLn5QGpBEA0ARCtTvxya0AqARCtTvaCVHXy1z4glACIJgCi1cnf+oBQdaoXpBIA0erU731AKAEQTQBEq9N/3BqQSgBE6wBuDkhVp//sA0LVmV6Qqs781QeEEgDRBEC0OvN3HxCqzvaCVAIgWp39pw8IJQCiCYBode7GzQGpOoClAakEQLQ6t9QHhBIA0ep8L0hV52/2AaEEQDQBEK0u3FoakEoARKsLy31AKAEQTQBEq4u3lwak6gBuDEglAKLVxTt9QCgBEK0u9YJUdeluHxBKAEQTANHq0r0+IFRd7gWpBEC0urzSB4QSANHq8fs3BqT6H8aeLkeeEG71AAAAAElFTkSuQmCC" />
  <link rel="apple-touch-icon" href="data:image/png;base64,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" />
  <style>
    :root {
      color-scheme: light dark;
      --primary: #005ea5;
      --accent: #28a197;
      --bg: #f5f7fa;
      --text: #222;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    header {
      background: linear-gradient(120deg, var(--primary), var(--accent));
      color: #fff;
      padding: 2.5rem 1rem;
      text-align: center;
    }

    header h1 {
      margin: 0 0 0.5rem;
      font-size: clamp(2rem, 3vw + 1rem, 3rem);
    }

    header p {
      max-width: 720px;
      margin: 0 auto;
      font-size: 1.05rem;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
      display: grid;
      gap: 1.5rem;
    }

    section {
      background: #fff;
      padding: 1.75rem;
      border-radius: 14px;
      box-shadow: 0 18px 24px -22px rgba(0, 0, 0, 0.45);
    }

    section h2 {
      margin-top: 0;
      color: var(--primary);
      font-size: 1.4rem;
    }

    section h3 {
      margin-top: 1.5rem;
      color: var(--accent);
      font-size: 1.15rem;
    }

    .two-column {
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 760px) {
      .two-column {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
      position: relative;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.1rem;
      height: 1.1rem;
      margin-left: 0.35rem;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      outline: none;
      vertical-align: middle;
    }

    .info-icon:focus-visible,
    .info-icon:hover {
      box-shadow: 0 0 0 3px rgba(40, 161, 151, 0.3);
    }

    .info-icon::after {
      content: '?';
    }

    .popover-bubble {
      position: fixed;
      max-width: min(320px, calc(100vw - 2rem));
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      box-shadow: 0 18px 28px -20px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 94, 165, 0.15);
      z-index: 1000;
      font-size: 0.9rem;
    }

    .popover-bubble.hidden {
      display: none;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid #d4d8dd;
      font-size: 1rem;
      background: #fdfdfd;
    }

    textarea {
      min-height: 110px;
      resize: vertical;
    }

    .checklist {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.75rem;
    }

    .checklist li {
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .checklist input[type="checkbox"] {
      margin-top: 0.35rem;
      width: 1.15rem;
      height: 1.15rem;
    }

    .download-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    button {
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px -12px rgba(0, 0, 0, 0.6);
    }

    .note {
      background: rgba(0, 94, 165, 0.08);
      border-left: 4px solid var(--primary);
      padding: 1rem;
      border-radius: 0 12px 12px 0;
      color: #0b1f3a;
      margin-top: 1rem;
    }

    details {
      margin-top: 1rem;
      background: rgba(40, 161, 151, 0.08);
      border-left: 4px solid var(--accent);
      padding: 0.75rem 1rem 1rem;
      border-radius: 0 12px 12px 0;
    }

    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--accent);
    }

    .calculation-block {
      margin-top: 1.5rem;
      border: 1px solid #d8e0e7;
      border-radius: 12px;
      padding: 1.25rem;
      background: linear-gradient(180deg, rgba(0, 94, 165, 0.05), rgba(255, 255, 255, 0.95));
    }

    .calculation-block p {
      margin-top: 0;
    }

    .calculation-results {
      margin-top: 1rem;
      border-radius: 10px;
      background: rgba(0, 94, 165, 0.07);
      padding: 1rem;
    }

    .calculation-results p {
      margin: 0.35rem 0;
    }

    .calculation-details table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.75rem;
    }

    .calculation-details th,
    .calculation-details td {
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 0.5rem;
      text-align: left;
    }

    .info-links ul {
      padding-left: 1.2rem;
      margin: 0.5rem 0 0;
    }

    .info-links a {
      color: var(--primary);
      text-decoration: none;
    }

    .info-links a:hover {
      text-decoration: underline;
    }

    footer {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>IGEM/UP/1 Testing &amp; Purging Procedure Builder</h1>
    <p>
      Use this planning template to assemble a site-specific procedure for testing and purging natural gas
      pipework in accordance with IGEM/UP/1. Complete each section, capture risk controls, and export the
      finished document for review and approval.
    </p>
  </header>
  <main>
    <section id="project-details">
      <h2>1. Project and Personnel Details</h2>
      <div class="two-column">
        <div>
          <label for="project-name">Project / Site Name</label>
          <input id="project-name" type="text" placeholder="e.g. ABC Manufacturing Plant" />
        </div>
        <div>
          <label for="location">Location</label>
          <input id="location" type="text" placeholder="Town / Postcode" />
        </div>
        <div>
          <label for="client">Client / Duty Holder</label>
          <input id="client" type="text" placeholder="Company or client representative" />
        </div>
        <div>
          <label for="prepared-by">Prepared By</label>
          <input id="prepared-by" type="text" placeholder="Engineer name &amp; role" />
        </div>
        <div>
          <label for="date">Procedure Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="gas-type">Gas Type</label>
          <select id="gas-type">
            <option value="natural">Natural Gas</option>
            <option value="lpg">LPG (Propane)</option>
            <option value="biomethane">Biomethane</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
    </section>

    <section id="system-overview">
      <h2>2. Pipework Overview</h2>
      <div class="two-column">
        <div>
          <label for="pipework-description">System Description</label>
          <textarea id="pipework-description" placeholder="Summarise pipe routes, sizes, materials and connected appliances"></textarea>
        </div>
        <div>
          <label for="drawing-reference">Drawings / References</label>
          <textarea id="drawing-reference" placeholder="Isometric drawings, schematics, IGEM references"></textarea>
        </div>
        <div>
          <label for="operating-pressure">
            Operating Pressure (mbar)
            <span
              class="info-icon"
              tabindex="0"
              role="button"
              aria-label="Explanation for operating pressure"
              data-popover="Working pressure under normal operating conditions. Used for baseline comparison with test pressures."
            ></span>
          </label>
          <input id="operating-pressure" type="number" min="0" step="0.1" />
        </div>
        <div>
          <label for="volume">
            Estimated System Volume (m³)
            <span
              class="info-icon"
              tabindex="0"
              role="button"
              aria-label="Explanation for system volume"
              data-popover="Sum of all pipe and component internal volumes being tested. Determines hold and purge times."
            ></span>
          </label>
          <input id="volume" type="number" min="0" step="0.01" />
        </div>
      </div>
    </section>

    <section id="testing-plan">
      <h2>3. Strength &amp; Tightness Testing Plan</h2>
      <div class="two-column">
        <div>
          <label for="test-standard">Test Standard / Clause</label>
          <input id="test-standard" type="text" placeholder="e.g. IGEM/UP/1 6.2" />
        </div>
        <div>
          <label for="test-medium">Test Medium</label>
          <input id="test-medium" type="text" placeholder="e.g. Air, Nitrogen" />
        </div>
        <div>
          <label for="test-pressure">Test Pressure</label>
          <input id="test-pressure" type="text" placeholder="kPa or bar" />
        </div>
        <div>
          <label for="test-duration">Test Duration</label>
          <input id="test-duration" type="text" placeholder="minutes" />
        </div>
      </div>
      <label for="test-procedure">Detailed Procedure</label>
      <textarea id="test-procedure" placeholder="List steps including isolation, test instrument calibration, stabilisation time and acceptance criteria."></textarea>
      <div class="note">
        <strong>Reminder:</strong> Document instrument calibration dates and verify leak detection fluid compatibility with pipe materials.
      </div>
      <div class="calculation-block">
        <h3>Calculation Support</h3>
        <p>
          Use these assisted calculations to document the rationale for your chosen test pressures and hold times. Values are stored
          with the rest of the template so that the full decision trail is available for audit.
        </p>
        <div class="two-column">
          <div>
            <label for="design-pressure">
              Design Pressure (mbar)
              <span
                class="info-icon"
                tabindex="0"
                role="button"
                aria-label="Explanation for design pressure"
                data-popover="Maximum operating pressure for the system. If left blank the operating pressure is used to determine the pressure category."
              ></span>
            </label>
            <input id="design-pressure" type="number" min="0" step="0.1" placeholder="Automatically use operating pressure if blank" />
          </div>
          <div>
            <label for="test-fill-rate">
              Expected Fill Rate (m³/h)
              <span
                class="info-icon"
                tabindex="0"
                role="button"
                aria-label="Explanation for fill rate"
                data-popover="Volume displaced during pressurisation. Used to estimate stabilisation time before holding the test pressure."
              ></span>
            </label>
            <input id="test-fill-rate" type="number" min="0" step="0.01" placeholder="Volume displaced during pressurisation" />
          </div>
          <div>
            <label for="test-temp-start">
              Start Temperature (°C)
              <span
                class="info-icon"
                tabindex="0"
                role="button"
                aria-label="Explanation for start temperature"
                data-popover="Ambient temperature at the beginning of the test. Helps quantify pressure changes due to temperature drift."
              ></span>
            </label>
            <input id="test-temp-start" type="number" step="0.1" placeholder="Ambient at start of test" />
          </div>
          <div>
            <label for="test-temp-end">
              End Temperature (°C)
              <span
                class="info-icon"
                tabindex="0"
                role="button"
                aria-label="Explanation for end temperature"
                data-popover="Ambient temperature at the end of the test. Compare with start value to calculate expected apparent pressure change."
              ></span>
            </label>
            <input id="test-temp-end" type="number" step="0.1" placeholder="Ambient at end of test" />
          </div>
        </div>
        <button type="button" id="calculate-test-plan">Calculate Recommendations</button>
        <div class="calculation-results" id="test-calculation-summary" role="status" aria-live="polite">
          Enter design pressure, volume and optional temperature data to generate recommendations.
        </div>
        <details id="test-calculation-details">
          <summary>Details</summary>
          <div class="calculation-details" id="test-calculation-details-body">
            Provide values and press “Calculate Recommendations” to see step-by-step calculations.
          </div>
        </details>
      </div>
    </section>

    <section id="purging-plan">
      <h2>4. Purging Plan</h2>
      <div class="two-column">
        <div>
          <label for="purge-method">Purging Method</label>
          <select id="purge-method">
            <option value="direct">Direct Purging (IGEM/UP/1 Section 7)</option>
            <option value="indirect">Indirect Purging</option>
            <option value="vacuum">Vacuum Purging</option>
          </select>
        </div>
        <div>
          <label for="purge-medium">Purge Medium</label>
          <input id="purge-medium" type="text" placeholder="e.g. Nitrogen" />
        </div>
      </div>
      <label for="purge-calculations">Purge Volume Calculations</label>
      <textarea id="purge-calculations" placeholder="Include pipe volume, purge factor, flow rate and total purge time."></textarea>
      <label for="purge-steps">Step-by-Step Instructions</label>
      <textarea id="purge-steps" placeholder="Pre-purge checks, purge sequence, confirmation of gas-free atmosphere, recommissioning."></textarea>
    </section>

    <section id="risk-assessment">
      <h2>5. Risk Controls &amp; Permits</h2>
      <ul class="checklist">
        <li>
          <input id="permit" type="checkbox" />
          <label for="permit">Permit-to-work / authorisation in place</label>
        </li>
        <li>
          <input id="competence" type="checkbox" />
          <label for="competence">Competent personnel appointed and briefed</label>
        </li>
        <li>
          <input id="monitoring" type="checkbox" />
          <label for="monitoring">Continuous atmosphere monitoring arranged</label>
        </li>
        <li>
          <input id="ventilation" type="checkbox" />
          <label for="ventilation">Ventilation routes confirmed and ignition sources controlled</label>
        </li>
        <li>
          <input id="ppe" type="checkbox" />
          <label for="ppe">PPE requirements communicated</label>
        </li>
      </ul>
      <label for="additional-controls">Additional Risk Controls</label>
      <textarea id="additional-controls" placeholder="Gas detection, fire cover, emergency arrangements, communication plan"></textarea>
    </section>

    <section id="acceptance">
      <h2>6. Acceptance Criteria &amp; Sign-off</h2>
      <div class="two-column">
        <div>
          <label for="acceptance-criteria">Acceptance Criteria</label>
          <textarea id="acceptance-criteria" placeholder="Pressure loss limits, test medium purity, purge endpoint readings"></textarea>
        </div>
        <div>
          <label for="signoff">Sign-off Requirements</label>
          <textarea id="signoff" placeholder="Engineer signature, witness, client representative, record retention"></textarea>
        </div>
      </div>
      <div class="note">
        Store the final signed procedure within project QA documentation and retain for traceability in accordance with IGEM/UP/1 clause 10.
      </div>
    </section>

    <section id="summary">
      <h2>7. Procedure Output</h2>
      <label for="summary-notes">Summary Notes</label>
      <textarea id="summary-notes" placeholder="Capture key outcomes, deviations from standards, or special considerations"></textarea>
      <div class="download-controls">
        <button type="button" onclick="window.print()">Print / Save as PDF</button>
        <button type="button" onclick="exportProcedure()">Download JSON</button>
        <button type="button" onclick="document.getElementById('import-file').click()">Load JSON</button>
        <input
          type="file"
          id="import-file"
          accept="application/json"
          style="display: none"
          aria-label="Load saved procedure JSON"
        />
      </div>
    </section>

    <section id="reference-info">
      <h2>8. Supporting Information</h2>
      <div class="info-links">
        <p>Reference material for further reading:</p>
        <ul>
          <li>
            <a href="https://igem.org.uk/technical-services/standards-and-guidance/igemup1" target="_blank" rel="noopener noreferrer">
              IGEM/UP/1 Edition 3 – Strength testing, tightness testing and direct purging of industrial and commercial gas installations
            </a>
          </li>
          <li>
            <a href="https://www.hse.gov.uk/gas/" target="_blank" rel="noopener noreferrer">UK Health and Safety Executive – Gas safety guidance</a>
          </li>
          <li>
            <a href="https://www.nationalgas.com/safety" target="_blank" rel="noopener noreferrer">National Gas – Safety and emergency procedures</a>
          </li>
        </ul>
      </div>
    </section>
  </main>

  <footer>
    © <span id="year"></span> Testing &amp; Purging Procedure Template · Aligns with IGEM/UP/1 good practice.
  </footer>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch((error) => {
          console.error('Service worker registration failed:', error);
        });
      });
    }

    const inputs = document.querySelectorAll(
      'input[type="text"], input[type="number"], input[type="date"], textarea, select, input[type="checkbox"]'
    );

    function applyInputData(data = {}) {
      inputs.forEach((input) => {
        if (!input.id) return;
        if (input.type === 'checkbox') {
          input.checked = Boolean(data[input.id]);
        } else if (Object.prototype.hasOwnProperty.call(data, input.id)) {
          input.value = data[input.id] ?? '';
        } else if (input.tagName !== 'SELECT') {
          input.value = '';
        }
      });
      document.dispatchEvent(new Event('procedure-data-updated'));
    }

    function loadState() {
      const saved = localStorage.getItem('igem-up1-procedure');
      if (!saved) return;
      try {
        const data = JSON.parse(saved);
        applyInputData(data);
      } catch (error) {
        console.error('Could not load saved state', error);
      }
    }

    function saveState() {
      const data = {};
      inputs.forEach((input) => {
        if (!input.id) return;
        if (input.type === 'checkbox') {
          data[input.id] = input.checked;
        } else {
          data[input.id] = input.value;
        }
      });
      localStorage.setItem('igem-up1-procedure', JSON.stringify(data));
    }

    function readNumber(input) {
      if (!input) return NaN;
      const value = parseFloat(input.value);
      return Number.isFinite(value) ? value : NaN;
    }

    function formatNumber(value, decimals = 2) {
      if (!Number.isFinite(value)) return '—';
      return Number(value).toFixed(decimals);
    }

    function calculateTestPlan() {
      const summary = document.getElementById('test-calculation-summary');
      const details = document.getElementById('test-calculation-details-body');
      if (!summary || !details) return;

      const designInput = document.getElementById('design-pressure');
      const operatingInput = document.getElementById('operating-pressure');
      const volumeInput = document.getElementById('volume');
      const fillRateInput = document.getElementById('test-fill-rate');
      const startTempInput = document.getElementById('test-temp-start');
      const endTempInput = document.getElementById('test-temp-end');
      const gasTypeInput = document.getElementById('gas-type');

      let designPressure = readNumber(designInput);
      const operatingPressure = readNumber(operatingInput);
      if (!Number.isFinite(designPressure)) {
        designPressure = operatingPressure;
      }

      const systemVolume = readNumber(volumeInput);
      const fillRate = readNumber(fillRateInput);
      const startTemp = readNumber(startTempInput);
      const endTemp = readNumber(endTempInput);
      const gasType = gasTypeInput ? gasTypeInput.options[gasTypeInput.selectedIndex].text : 'Unknown';

      if (!Number.isFinite(designPressure) || !Number.isFinite(systemVolume)) {
        summary.innerHTML =
          '<p>Please provide the design or operating pressure and the estimated system volume to generate recommendations.</p>';
        details.innerHTML =
          '<p>Set the operating pressure in the Pipework Overview and enter an estimated system volume. Optional fields help refine the stabilisation and temperature allowances.</p>';
        return;
      }

      const pressureThreshold = 75;
      const lowPressure = designPressure <= pressureThreshold;
      const algorithmLogic = lowPressure
        ? `Low-pressure algorithm applied because design pressure (${formatNumber(designPressure, 1)} mbar) is ≤ ${pressureThreshold} mbar.`
        : `Medium/high-pressure algorithm applied because design pressure (${formatNumber(designPressure, 1)} mbar) exceeds ${pressureThreshold} mbar.`;

      const strengthTestPressure = lowPressure
        ? Math.max(designPressure * 1.5, 150)
        : Math.max(designPressure * 1.5, 1000);

      let tightnessTestPressure = lowPressure ? Math.max(designPressure, 20) : Math.max(designPressure * 1.1, 300);
      tightnessTestPressure = Math.min(tightnessTestPressure, strengthTestPressure * 0.9);

      let holdTimeMinutes;
      if (systemVolume <= 0.03) {
        holdTimeMinutes = 5;
      } else if (systemVolume <= 0.1) {
        holdTimeMinutes = 10;
      } else {
        holdTimeMinutes = 20 + (systemVolume - 0.1) * 30;
      }
      holdTimeMinutes = Math.max(5, Math.min(holdTimeMinutes, 180));

      let stabilisationMinutes = NaN;
      if (Number.isFinite(systemVolume) && Number.isFinite(fillRate) && fillRate > 0) {
        stabilisationMinutes = Math.max(10, (systemVolume / fillRate) * 60 + 5);
      }

      let temperatureCompensation = NaN;
      let temperatureNarrative = '';
      if (Number.isFinite(startTemp) && Number.isFinite(endTemp)) {
        const deltaTemp = endTemp - startTemp;
        const absoluteStart = startTemp + 273.15;
        if (absoluteStart > 0) {
          temperatureCompensation = tightnessTestPressure * (deltaTemp / absoluteStart);
          temperatureNarrative =
            deltaTemp === 0
              ? 'No ambient temperature change detected during the test window.'
              : `Temperature ${deltaTemp > 0 ? 'increase' : 'decrease'} of ${formatNumber(Math.abs(deltaTemp), 1)} °C would cause an apparent pressure ${
                  deltaTemp > 0 ? 'rise' : 'fall'
                } of approximately ${formatNumber(Math.abs(temperatureCompensation), 2)} mbar.`;
        }
      }

      summary.innerHTML = `
        <p><strong>Algorithm used:</strong> ${algorithmLogic}</p>
        <p><strong>Recommended strength test pressure:</strong> ${formatNumber(strengthTestPressure, 1)} mbar.</p>
        <p><strong>Recommended tightness test pressure:</strong> ${formatNumber(tightnessTestPressure, 1)} mbar.</p>
        <p><strong>Minimum hold time:</strong> ${formatNumber(holdTimeMinutes, 1)} minutes based on system volume.</p>
        ${Number.isFinite(stabilisationMinutes) ? `<p><strong>Suggested stabilisation time:</strong> ${formatNumber(stabilisationMinutes, 1)} minutes, derived from fill rate.</p>` : ''}
        ${temperatureNarrative ? `<p><strong>Temperature effect:</strong> ${temperatureNarrative}</p>` : ''}
        <p><strong>Gas type context:</strong> ${gasType}.</p>
      `;

      const detailedRows = [
        ['Design pressure (mbar)', formatNumber(designPressure, 2)],
        ['Operating pressure (mbar)', Number.isFinite(operatingPressure) ? formatNumber(operatingPressure, 2) : 'Not provided'],
        ['System volume (m³)', formatNumber(systemVolume, 3)],
        ['Expected fill rate (m³/h)', Number.isFinite(fillRate) ? formatNumber(fillRate, 2) : 'Not provided'],
        ['Start temperature (°C)', Number.isFinite(startTemp) ? formatNumber(startTemp, 1) : 'Not provided'],
        ['End temperature (°C)', Number.isFinite(endTemp) ? formatNumber(endTemp, 1) : 'Not provided'],
      ];

      const calculationSteps = `
        <ol>
          <li>Determine pressure category by comparing design pressure with ${pressureThreshold} mbar.</li>
          <li>Strength test pressure = max(1.5 × design pressure, ${lowPressure ? '150' : '1000'} mbar).</li>
          <li>Tightness test pressure limited to 90% of strength recommendation and at least ${
            lowPressure ? 'the design pressure or 20 mbar' : '10% above design pressure and ≥300 mbar'
          }.</li>
          <li>Hold time set from volume bands: ≤0.03 m³ → 5 min, 0.03–0.1 m³ → 10 min, additional 30 min per extra m³ beyond 0.1 m³.</li>
          <li>${
            Number.isFinite(stabilisationMinutes)
              ? 'Stabilisation time = ((volume ÷ fill rate) × 60) + 5 minutes, minimum 10 minutes.'
              : 'Provide a fill rate to calculate the stabilisation time.'
          }</li>
          <li>${
            Number.isFinite(temperatureCompensation)
              ? 'Temperature compensation uses ΔP = P × ΔT ÷ (T₁ + 273.15).' 
              : 'Enter start and end temperatures to estimate apparent pressure change from temperature variation.'
          }</li>
        </ol>
      `;

      const resultList = `
        <ul>
          <li>Strength test pressure: ${formatNumber(strengthTestPressure, 1)} mbar.</li>
          <li>Tightness test pressure: ${formatNumber(tightnessTestPressure, 1)} mbar.</li>
          <li>Minimum hold time: ${formatNumber(holdTimeMinutes, 1)} minutes.</li>
          ${Number.isFinite(stabilisationMinutes) ? `<li>Suggested stabilisation time: ${formatNumber(stabilisationMinutes, 1)} minutes.</li>` : ''}
          ${Number.isFinite(temperatureCompensation) ? `<li>Temperature-induced apparent pressure change: ±${formatNumber(Math.abs(temperatureCompensation), 2)} mbar.</li>` : ''}
        </ul>
      `;

      details.innerHTML = `
        <h4>Initial data</h4>
        <table>
          <thead>
            <tr><th>Variable</th><th>Value</th></tr>
          </thead>
          <tbody>
            ${detailedRows
              .map((row) => `<tr><td>${row[0]}</td><td>${row[1]}</td></tr>`)
              .join('')}
          </tbody>
        </table>
        <h4>Calculations</h4>
        ${calculationSteps}
        <h4>Results</h4>
        ${resultList}
      `;
    }

    function exportProcedure() {
      const data = {};
      inputs.forEach((input) => {
        if (!input.id) return;
        if (input.type === 'checkbox') {
          data[input.id] = input.checked;
        } else {
          data[input.id] = input.value;
        }
      });
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'igem-up1-procedure.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function handleImportData(objectData) {
      if (!objectData || typeof objectData !== 'object') {
        throw new Error('The provided JSON does not contain form data.');
      }
      applyInputData(objectData);
      saveState();
      calculateTestPlan();
    }

    const importInput = document.getElementById('import-file');
    if (importInput) {
      importInput.addEventListener('change', (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const parsed = JSON.parse(String(e.target?.result || '')); 
            handleImportData(parsed);
          } catch (error) {
            alert(`Unable to load procedure: ${error instanceof Error ? error.message : 'Unknown error'}`);
            console.error('Import failed', error);
          } finally {
            importInput.value = '';
          }
        };
        reader.readAsText(file);
      });
    }

    inputs.forEach((input) => {
      input.addEventListener('input', saveState);
      if (input.type === 'checkbox') {
        input.addEventListener('change', saveState);
      }
    });

    const calculateButton = document.getElementById('calculate-test-plan');
    if (calculateButton) {
      calculateButton.addEventListener('click', () => {
        calculateTestPlan();
        saveState();
      });
    }

    const designPressureInput = document.getElementById('design-pressure');
    const operatingPressureInput = document.getElementById('operating-pressure');
    if (designPressureInput && operatingPressureInput) {
      const syncDesignPlaceholder = () => {
        if (!designPressureInput.value) {
          const op = parseFloat(operatingPressureInput.value);
          designPressureInput.placeholder = Number.isFinite(op)
            ? `Using operating pressure (${op.toFixed(1)} mbar)`
            : 'Automatically use operating pressure if blank';
        } else {
          designPressureInput.placeholder = 'Design pressure overrides operating pressure';
        }
      };
      operatingPressureInput.addEventListener('input', () => {
        syncDesignPlaceholder();
        saveState();
      });
      designPressureInput.addEventListener('input', syncDesignPlaceholder);
      syncDesignPlaceholder();
    }

    const popover = document.createElement('div');
    popover.className = 'popover-bubble hidden';
    popover.setAttribute('role', 'status');
    popover.setAttribute('aria-live', 'polite');
    popover.setAttribute('aria-hidden', 'true');
    document.body.appendChild(popover);

    let activePopoverTrigger = null;

    function positionPopover(target) {
      if (!target) return;
      popover.classList.remove('hidden');
      popover.textContent = target.getAttribute('data-popover') || '';
      popover.setAttribute('aria-hidden', 'false');
      popover.style.top = '0px';
      popover.style.left = '0px';
      const popRect = popover.getBoundingClientRect();
      const { width, height } = popRect;
      const rect = target.getBoundingClientRect();
      const padding = 12;
      const left = Math.min(
        window.innerWidth - width - padding,
        Math.max(padding, rect.left + rect.width / 2 - width / 2)
      );
      const top = Math.min(
        window.innerHeight - height - padding,
        Math.max(padding, rect.bottom + 10)
      );
      popover.style.left = `${left}px`;
      popover.style.top = `${top}px`;
    }

    function hidePopover() {
      popover.classList.add('hidden');
      popover.textContent = '';
      popover.setAttribute('aria-hidden', 'true');
      activePopoverTrigger = null;
    }

    function showPopover(target) {
      if (!target) return;
      activePopoverTrigger = target;
      positionPopover(target);
    }

    const infoIcons = document.querySelectorAll('.info-icon');
    infoIcons.forEach((icon) => {
      icon.addEventListener('mouseenter', () => showPopover(icon));
      icon.addEventListener('mouseleave', () => {
        if (document.activeElement !== icon) {
          hidePopover();
        }
      });
      icon.addEventListener('focus', () => showPopover(icon));
      icon.addEventListener('blur', hidePopover);
      icon.addEventListener('click', (event) => {
        event.preventDefault();
        if (activePopoverTrigger === icon && !popover.classList.contains('hidden')) {
          hidePopover();
        } else {
          showPopover(icon);
        }
      });
      icon.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hidePopover();
          icon.blur();
        }
      });
    });

    window.addEventListener('scroll', () => {
      if (activePopoverTrigger) {
        positionPopover(activePopoverTrigger);
      }
    });

    window.addEventListener('resize', () => {
      if (activePopoverTrigger) {
        positionPopover(activePopoverTrigger);
      }
    });

    document.addEventListener('procedure-data-updated', () => {
      if (designPressureInput && operatingPressureInput) {
        const event = new Event('input');
        operatingPressureInput.dispatchEvent(event);
        designPressureInput.dispatchEvent(event);
      }
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    loadState();
    calculateTestPlan();
  </script>
</body>
</html>
